{% extends "base.html" %}

{% block title %}Jira Test Generation - Agentic RAG{% endblock %}

{% block content %}
<div class="container-fluid mt-5 pt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white border-0 rounded-4">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-1">
                                <i class="fas fa-robot me-3"></i>
                                Jira Test Generation Dashboard
                            </h2>
                            <p class="mb-0 opacity-75">
                                Connected to project: <strong>{{ project }}</strong>
                            </p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="d-flex flex-column align-items-md-end">
                                <div class="status-indicator mb-2">
                                    <span class="badge bg-success fs-6">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Jira Connected
                                    </span>
                                </div>
                                <small class="opacity-75">{{ jira_url }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Query Interface -->
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 rounded-4 mb-4">
                <div class="card-header bg-light border-0 py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-pencil-alt me-2 text-primary"></i>
                        Test Generation Prompt
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form id="queryForm">
                        <div class="mb-3">
                            <label for="queryInput" class="form-label">
                                Describe the functionality you want to test:
                            </label>
                            <textarea 
                                class="form-control form-control-lg" 
                                id="queryInput" 
                                name="query" 
                                rows="4" 
                                placeholder="Example: Create test cases for user authentication with email and password validation, including edge cases for invalid credentials and account lockout scenarios..."
                                required></textarea>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="generateBtn">
                                <i class="fas fa-magic me-2"></i>
                                Generate Test Cases
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingSection" class="card shadow-sm border-0 rounded-4 mb-4" style="display: none;">
                <div class="card-body text-center p-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Generating Test Cases...</h5>
                    <p class="text-muted mb-0">Analyzing existing tests and creating comprehensive test cases for your requirements.</p>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" style="display: none;">
                <div class="card shadow-sm border-0 rounded-4 mb-4">
                    <div class="card-header bg-success text-white border-0 py-3">
                        <h5 class="mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            Generated Test Cases
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div id="resultsContent">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Section -->
            <div id="errorSection" class="card shadow-sm border-0 rounded-4 mb-4" style="display: none;">
                <div class="card-header bg-danger text-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div id="errorContent">
                        <!-- Error message will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Side Panel -->
        <div class="col-lg-4">
            <!-- System Status -->
            <div class="card shadow-sm border-0 rounded-4 mb-4">
                <div class="card-header bg-light border-0 py-3">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2 text-info"></i>
                        System Status
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div id="systemStatus">
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow-sm border-0 rounded-4 mb-4">
                <div class="card-header bg-light border-0 py-3">
                    <h6 class="mb-0">
                        <i class="fas fa-bolt me-2 text-warning"></i>
                        Quick Actions
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="d-grid gap-2">
                        <a href="{{ jira_url }}/projects/{{ project }}" 
                           target="_blank" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt me-2"></i>
                            View in Jira
                        </a>
                        <button type="button" 
                                class="btn btn-outline-info btn-sm" 
                                onclick="refreshStatus()">
                            <i class="fas fa-sync-alt me-2"></i>
                            Refresh Status
                        </button>
                        <a href="{{ url_for('select_jira_project') }}" 
                           class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left me-2"></i>
                            Change Project
                        </a>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-header bg-light border-0 py-3">
                    <h6 class="mb-0">
                        <i class="fas fa-history me-2 text-secondary"></i>
                        Recent Activity
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div id="recentActivity">
                        <p class="text-muted small mb-0">No recent activity</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const queryForm = document.getElementById('queryForm');
    const queryInput = document.getElementById('queryInput');
    const generateBtn = document.getElementById('generateBtn');
    const loadingSection = document.getElementById('loadingSection');
    const resultsSection = document.getElementById('resultsSection');
    const errorSection = document.getElementById('errorSection');
    
    // Load system status
    loadSystemStatus();
    
    // Form submission
    queryForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const query = queryInput.value.trim();
        if (!query) {
            showNotification('Please enter a query', 'warning');
            return;
        }
        
        // Show loading state
        hideAllSections();
        loadingSection.style.display = 'block';
        generateBtn.disabled = true;
        
        // Submit query
        fetch('{{ url_for("process_jira_query") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `query=${encodeURIComponent(query)}`
        })
        .then(response => response.json())
        .then(data => {
            hideAllSections();
            generateBtn.disabled = false;
            
            if (data.error) {
                showError(data.error);
            } else {
                showResults(data);
                addToRecentActivity(query);
            }
            
            // Refresh status after processing
            setTimeout(loadSystemStatus, 2000);
        })
        .catch(error => {
            hideAllSections();
            generateBtn.disabled = false;
            showError('Failed to process query: ' + error.message);
        });
    });
    
    function hideAllSections() {
        loadingSection.style.display = 'none';
        resultsSection.style.display = 'none';
        errorSection.style.display = 'none';
    }
    
    function showResults(data) {
        const resultsContent = document.getElementById('resultsContent');
        let html = '';
        
        if (data.analysis) {
            html += '<div class="mb-4">';
            html += '<h6><i class="fas fa-chart-line me-2"></i>Analysis</h6>';
            html += '<div class="bg-light p-3 rounded">';
            html += `<p><strong>Existing Functionality:</strong> ${data.analysis.existing_functionality ? 'Yes' : 'No'}</p>`;
            html += `<p><strong>Existing Tests:</strong> ${data.analysis.existing_tests ? 'Yes' : 'No'}</p>`;
            html += `<p><strong>Needs New Tests:</strong> ${data.analysis.needs_new_tests ? 'Yes' : 'No'}</p>`;
            if (data.analysis.recommendations) {
                html += '<p><strong>Recommendations:</strong></p>';
                html += '<ul>';
                data.analysis.recommendations.forEach(rec => {
                    html += `<li>${rec}</li>`;
                });
                html += '</ul>';
            }
            html += '</div></div>';
        }
        
        if (data.generated_tests) {
            html += '<div class="mb-4">';
            html += '<h6><i class="fas fa-code me-2"></i>Generated Test Cases</h6>';
            
            if (data.generated_tests.test_cases) {
                html += '<div class="mb-3">';
                html += '<h7><strong>Test Cases:</strong></h7>';
                data.generated_tests.test_cases.forEach((testCase, index) => {
                    html += '<div class="card mt-2">';
                    html += '<div class="card-body p-3">';
                    html += `<h8><strong>${testCase.name || 'Test Case ' + (index + 1)}</strong></h8>`;
                    html += `<p class="mb-2">${testCase.description || 'No description'}</p>`;
                    if (testCase.steps) {
                        html += '<p><strong>Steps:</strong></p>';
                        html += '<ol>';
                        testCase.steps.forEach(step => {
                            html += `<li>${step}</li>`;
                        });
                        html += '</ol>';
                    }
                    if (testCase.expected_result) {
                        html += `<p><strong>Expected Result:</strong> ${testCase.expected_result}</p>`;
                    }
                    html += '</div></div>';
                });
                html += '</div>';
            }
            
            if (data.generated_tests.test_code) {
                html += '<div class="mb-3">';
                html += '<h7><strong>Test Code:</strong></h7>';
                html += '<pre class="bg-dark text-light p-3 rounded"><code>';
                html += escapeHtml(data.generated_tests.test_code);
                html += '</code></pre>';
                html += '</div>';
            }
            
            html += '<div class="alert alert-success">';
            html += '<i class="fas fa-check-circle me-2"></i>';
            html += 'Test cases have been generated and updated in your Jira project!';
            html += '</div>';
        }
        
        if (data.message) {
            html += `<div class="alert alert-info">${data.message}</div>`;
        }
        
        resultsContent.innerHTML = html;
        resultsSection.style.display = 'block';
    }
    
    function showError(error) {
        document.getElementById('errorContent').innerHTML = `<p class="mb-0">${error}</p>`;
        errorSection.style.display = 'block';
    }
    
    function loadSystemStatus() {
        fetch('{{ url_for("status") }}')
        .then(response => response.json())
        .then(data => {
            const statusHtml = `
                <div class="row g-2">
                    <div class="col-6">
                        <div class="text-center p-2 bg-${data.jira_connected ? 'success' : 'danger'} bg-opacity-10 rounded">
                            <small class="d-block text-${data.jira_connected ? 'success' : 'danger'}">
                                <i class="fas fa-${data.jira_connected ? 'check' : 'times'} me-1"></i>
                                Jira
                            </small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-2 bg-${data.project_selected ? 'success' : 'warning'} bg-opacity-10 rounded">
                            <small class="d-block text-${data.project_selected ? 'success' : 'warning'}">
                                <i class="fas fa-${data.project_selected ? 'check' : 'exclamation'} me-1"></i>
                                Project
                            </small>
                        </div>
                    </div>
                    <div class="col-12 mt-2">
                        <small class="text-muted d-block">
                            <strong>Test Cases:</strong> ${data.collections_info ? data.collections_info.tests_count : 0}
                        </small>
                    </div>
                </div>
            `;
            document.getElementById('systemStatus').innerHTML = statusHtml;
        })
        .catch(error => {
            document.getElementById('systemStatus').innerHTML = '<small class="text-danger">Status unavailable</small>';
        });
    }
    
    function addToRecentActivity(query) {
        const activity = document.getElementById('recentActivity');
        const time = new Date().toLocaleTimeString();
        const newActivity = `
            <div class="border-bottom pb-2 mb-2">
                <small class="text-muted">${time}</small>
                <p class="small mb-0">${query.substring(0, 50)}${query.length > 50 ? '...' : ''}</p>
            </div>
        `;
        activity.innerHTML = newActivity + activity.innerHTML;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Global function for refresh button
    window.refreshStatus = loadSystemStatus;
});
</script>
{% endblock %}
