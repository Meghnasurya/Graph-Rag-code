{% extends "base.html" %}

{% block title %}Select Jira Project - Agentic RAG{% endblock %}

{% block content %}
<div class="container-fluid mt-5 pt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-gradient-primary text-white text-center py-4">
                    <h2 class="mb-0">
                        <i class="fas fa-tasks me-3"></i>
                        Select Jira Project
                    </h2>
                    <p class="mb-0 mt-2 opacity-75">Choose a Jira project for test generation</p>
                </div>
                <div class="card-body p-5">
                    {% if sites %}
                    <form id="jiraProjectForm" method="post" action="{{ url_for('process_jira_selection') }}">
                        <div class="mb-4">
                            <label for="jira_site" class="form-label h5">
                                <i class="fas fa-building me-2 text-primary"></i>
                                Select Jira Site
                            </label>
                            <select class="form-select form-select-lg" id="jira_site" name="jira_site" required>
                                <option value="">Choose a Jira site...</option>
                                {% for site in sites %}
                                <option value="{{ site.url }}" data-site-id="{{ site.id }}">
                                    {{ site.name }} ({{ site.url }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-4" id="projectsSection" style="display: none;">
                            <label for="jira_project" class="form-label h5">
                                <i class="fas fa-project-diagram me-2 text-success"></i>
                                Select Project
                            </label>
                            <select class="form-select form-select-lg" id="jira_project" name="jira_project">
                                <option value="">Loading projects...</option>
                            </select>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg" id="submitBtn" disabled>
                                <i class="fas fa-arrow-right me-2"></i>
                                Continue to Test Generation
                            </button>
                        </div>
                    </form>
                    {% else %}
                    <div class="text-center">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No Jira sites found. Please check your authentication.
                        </div>
                        <a href="{{ url_for('jira_auth') }}" class="btn btn-primary">
                            <i class="fas fa-redo me-2"></i>
                            Retry Authentication
                        </a>
                    </div>
                    {% endif %}

                    <div class="text-center mt-4">
                        <a href="{{ url_for('login') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            Back to Login
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Loading Projects...</h5>
                <p class="text-muted mb-0">Please wait while we fetch your Jira projects.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const siteSelect = document.getElementById('jira_site');
    const projectSelect = document.getElementById('jira_project');
    const projectsSection = document.getElementById('projectsSection');
    const submitBtn = document.getElementById('submitBtn');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));

    siteSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const siteUrl = this.value;
        const siteId = selectedOption.dataset.siteId;

        if (siteUrl && siteId) {
            loadingModal.show();
            
            fetch('{{ url_for("get_projects") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `site_url=${encodeURIComponent(siteUrl)}&site_id=${encodeURIComponent(siteId)}`
            })
            .then(response => response.json())
            .then(data => {
                loadingModal.hide();
                if (data.projects) {
                    projectSelect.innerHTML = '<option value="">Choose a project...</option>';
                    data.projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.key;
                        option.textContent = `${project.name} (${project.key})`;
                        projectSelect.appendChild(option);
                    });
                    projectsSection.style.display = 'block';
                } else {
                    showNotification('Error loading projects: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                loadingModal.hide();
                showNotification('Error loading projects: ' + error.message, 'error');
            });
        } else {
            projectsSection.style.display = 'none';
            submitBtn.disabled = true;
        }
    });

    projectSelect.addEventListener('change', function() {
        submitBtn.disabled = !this.value;
    });
});
</script>
{% endblock %}
