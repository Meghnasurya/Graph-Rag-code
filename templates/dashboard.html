{% extends "base.html" %}

{% block title %}Dashboard - Agentic RAG System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card-modern p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="mb-2">
                            <i class="fas fa-tachometer-alt me-2 text-primary"></i>
                            Dashboard
                        </h2>
                        <p class="text-muted mb-0">
                            Generate intelligent test cases using AI-powered analysis of your codebase and requirements.
                        </p>
                    </div>                    <div class="col-md-4 text-md-end">
                        <div class="d-flex gap-2 justify-content-md-end flex-wrap">
                            <span class="status-indicator {% if github_connected %}status-connected{% else %}status-disconnected{% endif %}" id="github-status">
                                <i class="fab fa-github me-1"></i>
                                <span id="github-text">GitHub {% if github_connected %}Connected{% else %}Disconnected{% endif %}</span>
                            </span>
                            <span class="status-indicator {% if jira_connected %}status-connected{% else %}status-disconnected{% endif %}" id="jira-status">
                                <i class="fab fa-atlassian me-1"></i>
                                <span id="jira-text">Jira {% if jira_connected %}Connected{% else %}Disconnected{% endif %}</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>    <!-- Connection Status -->
    <div class="row mb-4" id="connection-alerts">
        {% if not github_connected %}
        <div class="col-12">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>GitHub not connected.</strong> 
                <a href="{{ url_for('github_auth') }}" class="alert-link">Connect your GitHub account</a> to access repositories.
            </div>
        </div>
        {% endif %}
        
        {% if not jira_connected %}
        <div class="col-12">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Jira not connected.</strong> 
                <a href="{{ url_for('jira_auth') }}" class="alert-link">Connect your Jira account</a> to manage test cases.
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Query Interface - Show if either GitHub repo or Jira project is selected -->
    {% if (github_repo_selected or jira_project_selected) %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="query-container">
                <h4 class="mb-3">
                    <i class="fas fa-search me-2 text-primary"></i>
                    Test Generation Query
                </h4>
                
                <div class="alert alert-info mb-3">
                    <div class="row">
                        {% if github_repo_selected %}
                        <div class="col-md-6">
                            <i class="fab fa-github me-2"></i>
                            <strong>GitHub:</strong> {{ github_repo_selected }}
                        </div>
                        {% endif %}
                        {% if jira_project_selected %}
                        <div class="col-md-6">
                            <i class="fab fa-atlassian me-2"></i>
                            <strong>Jira:</strong> {{ jira_project_selected }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <form id="queryForm">
                    <div class="mb-3">
                        <label for="queryInput" class="form-label fw-semibold">
                            Describe your testing requirements:
                        </label>
                        <textarea 
                            class="form-control" 
                            id="queryInput" 
                            name="query"
                            rows="4" 
                            placeholder="Example: Create unit tests for user authentication functionality including password validation, session management, and error handling..."
                            required
                        ></textarea>
                        <div class="form-text">
                            <i class="fas fa-lightbulb me-1"></i>
                            Be specific about the functionality you want to test. The AI will analyze your codebase and generate appropriate test cases.
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 align-items-center">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-magic me-2"></i>
                            Generate Tests
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="clearQuery">
                            <i class="fas fa-eraser me-1"></i>
                            Clear
                        </button>
                        {% if jira_project_selected %}
                        <div class="ms-auto">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Tests will be created/updated in your selected Jira project
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% else %}    <!-- Repository and Project Selection -->
    <div class="row mb-4">
        {% if github_connected %}
        <div class="col-md-6 mb-3">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fab fa-github me-2"></i>
                        Select GitHub Repository
                    </h5>
                </div>
                <div class="card-body">
                    {% if github_repo_selected %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Selected: <strong>{{ github_repo_selected }}</strong>
                        <button class="btn btn-sm btn-outline-success ms-2" onclick="clearGithubSelection()">Change</button>
                    </div>
                    {% else %}
                    <form id="githubRepoForm">
                        <div class="mb-3">
                            <label for="githubRepo" class="form-label">Choose Repository:</label>
                            <select class="form-select" id="githubRepo" name="github_repo" required>
                                <option value="">Select a repository...</option>
                                {% for repo in github_repos %}
                                <option value="{{ repo.full_name }}">
                                    {{ repo.name }} {% if repo.description %}({{ repo.description[:50] }}...){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check me-1"></i>
                            Select Repository
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if jira_connected %}
        <div class="col-md-6 mb-3">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fab fa-atlassian me-2"></i>
                        Select Jira Project
                    </h5>
                </div>
                <div class="card-body">
                    {% if jira_project_selected %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Selected: <strong>{{ jira_project_selected }}</strong>
                        <button class="btn btn-sm btn-outline-success ms-2" onclick="clearJiraSelection()">Change</button>
                    </div>
                    {% else %}
                    <form id="jiraProjectForm">
                        <div class="mb-3">
                            <label for="jiraProject" class="form-label">Choose Project:</label>
                            <select class="form-select" id="jiraProject" name="jira_project" required>
                                <option value="">Select a project...</option>
                                {% for project in jira_projects %}
                                <option value="{{ project.key }}" data-site-url="{{ project.site_url }}">
                                    {{ project.name }} ({{ project.key }}) - {{ project.site_name }}
                                </option>
                                {% endfor %}
                            </select>
                            <input type="hidden" id="jiraSiteUrl" name="jira_site_url">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check me-1"></i>
                            Select Project
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Loading State -->
    <div class="row mb-4" id="loading-section" style="display: none;">
        <div class="col-12">
            <div class="card-modern p-4 text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Analyzing Requirements & Generating Tests...</h5>
                <p class="text-muted mb-0">
                    <span id="loading-text">Processing your request...</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="row" id="results-section" style="display: none;">
        <div class="col-12">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle me-2 text-success"></i>
                        Test Generation Results
                    </h5>
                </div>
                <div class="card-body" id="results-content">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    </div>    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <h5 class="mb-3">
                <i class="fas fa-bolt me-2 text-warning"></i>
                Quick Actions
            </h5>
        </div>
        <div class="col-md-4 mb-3">
            <div class="action-card">
                <div class="action-icon">
                    <i class="fab fa-github"></i>
                </div>
                <h6>Repository Selection</h6>
                <p>Choose and analyze your GitHub repositories</p>
                {% if session.get('selected_github_repo') %}
                <button class="btn btn-outline-primary btn-sm" onclick="clearGithubSelection()">
                    <i class="fas fa-sync me-1"></i>
                    Change Repo
                </button>
                {% else %}
                <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
                    <i class="fas fa-plus me-1"></i>
                    Select Repo
                </button>
                {% endif %}
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="action-card">
                <div class="action-icon">
                    <i class="fab fa-atlassian"></i>
                </div>
                <h6>Project Management</h6>
                <p>Configure your Jira projects and test management</p>
                {% if session.get('selected_jira_project') %}
                <button class="btn btn-outline-primary btn-sm" onclick="clearJiraSelection()">
                    <i class="fas fa-sync me-1"></i>
                    Change Project
                </button>
                {% else %}
                <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
                    <i class="fas fa-plus me-1"></i>
                    Select Project
                </button>
                {% endif %}
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="action-card">
                <div class="action-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h6>System Status</h6>
                <p>View embeddings, collections, and system health</p>
                <button class="btn btn-outline-primary btn-sm" onclick="checkStatus()">
                    <i class="fas fa-heartbeat me-1"></i>
                    Check Status
                </button>
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="row" id="status-section" style="display: none;">
        <div class="col-12">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-server me-2 text-info"></i>
                        System Status
                    </h5>
                </div>
                <div class="card-body" id="status-content">
                    <!-- Status will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const queryForm = document.getElementById('queryForm');
    const queryInput = document.getElementById('queryInput');
    const loadingSection = document.getElementById('loading-section');
    const resultsSection = document.getElementById('results-section');
    const resultsContent = document.getElementById('results-content');
    const clearButton = document.getElementById('clearQuery');
    const githubRepoForm = document.getElementById('githubRepoForm');
    const jiraProjectForm = document.getElementById('jiraProjectForm');
    const jiraProjectSelect = document.getElementById('jiraProject');
    const jiraSiteUrlInput = document.getElementById('jiraSiteUrl');

    // Auto-check status on page load
    checkStatus();    // Handle GitHub repository selection
    if (githubRepoForm) {
        githubRepoForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(githubRepoForm);
            const repoSelect = document.getElementById('githubRepo');
            const selectedRepo = repoSelect.value;
            
            if (!selectedRepo) {
                showError('Please select a repository');
                return;
            }
            
            try {
                // Show loading
                const submitButton = githubRepoForm.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
                submitButton.disabled = true;
                
                const response = await fetch('/select-github-repo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        github_repo: selectedRepo
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message);
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showError(result.error || 'Failed to select repository');
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                }
            } catch (error) {
                showError('Error selecting repository: ' + error.message);
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });
    }

    // Handle Jira project selection
    if (jiraProjectForm) {
        // Update site URL when project changes
        if (jiraProjectSelect) {
            jiraProjectSelect.addEventListener('change', function() {
                const selectedOption = jiraProjectSelect.options[jiraProjectSelect.selectedIndex];
                const siteUrl = selectedOption.getAttribute('data-site-url');
                if (jiraSiteUrlInput) {
                    jiraSiteUrlInput.value = siteUrl || '';
                }
            });
        }

        jiraProjectForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const projectSelect = document.getElementById('jiraProject');
            const selectedProject = projectSelect.value;
            const siteUrl = document.getElementById('jiraSiteUrl').value;
            
            if (!selectedProject || !siteUrl) {
                showError('Please select a project');
                return;
            }
            
            try {
                // Show loading
                const submitButton = jiraProjectForm.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
                submitButton.disabled = true;
                
                const response = await fetch('/select-jira-project-api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        jira_project: selectedProject,
                        jira_site_url: siteUrl
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message);
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showError(result.error || 'Failed to select project');
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                }
            } catch (error) {
                showError('Error selecting project: ' + error.message);
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });
    }

    // Handle form submission
    if (queryForm) {
        queryForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const query = queryInput.value.trim();
            if (!query) return;

            // Show loading state
            loadingSection.style.display = 'block';
            resultsSection.style.display = 'none';
            
            // Update loading text
            const loadingTexts = [
                'Analyzing your repository...',
                'Searching existing documentation...',
                'Reviewing current test coverage...',
                'Generating new test cases...',
                'Updating Jira test repository...'
            ];
            
            let textIndex = 0;
            const loadingTextElement = document.getElementById('loading-text');
            const loadingInterval = setInterval(() => {
                loadingTextElement.textContent = loadingTexts[textIndex];
                textIndex = (textIndex + 1) % loadingTexts.length;
            }, 2000);

            try {
                const formData = new FormData();
                formData.append('query', query);

                const response = await fetch('/query', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                clearInterval(loadingInterval);
                loadingSection.style.display = 'none';
                
                if (result.error) {
                    showError(result.error);
                } else {
                    showResults(result);
                }
                
            } catch (error) {
                clearInterval(loadingInterval);
                loadingSection.style.display = 'none';
                showError('Failed to process query: ' + error.message);
            }
        });
    }

    // Clear query
    if (clearButton) {
        clearButton.addEventListener('click', function() {
            queryInput.value = '';
            resultsSection.style.display = 'none';
        });
    }    function showResults(result) {
        let html = '<div class="row">';
        
        // Analysis section
        if (result.analysis) {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="result-card">
                        <h6><i class="fas fa-analytics me-2"></i>Analysis</h6>
                        <ul class="list-unstyled mb-0">
                            <li><strong>Existing functionality:</strong> ${result.analysis.existing_functionality ? 'Yes' : 'No'}</li>
                            <li><strong>Existing tests:</strong> ${result.analysis.existing_tests ? 'Yes' : 'No'}</li>
                            <li><strong>Needs new tests:</strong> ${result.analysis.needs_new_tests ? 'Yes' : 'No'}</li>
                            <li><strong>Needs test updates:</strong> ${result.analysis.needs_test_updates ? 'Yes' : 'No'}</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // Generated tests section
        if (result.generated_tests) {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="result-card">
                        <h6><i class="fas fa-code me-2"></i>Generated Tests</h6>
                        <p><strong>File:</strong> ${result.generated_tests.file_name || 'N/A'}</p>
                        <p><strong>Test Cases:</strong> ${result.generated_tests.test_cases ? result.generated_tests.test_cases.length : 0}</p>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="showTestDetails(${JSON.stringify(result.generated_tests).replace(/"/g, '&quot;')})">
                                <i class="fas fa-eye me-1"></i>View Details
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        html += '</div>';

        // Success message
        if (result.updated_embeddings) {
            html += `
                <div class="alert alert-success mt-3">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Success!</strong> Tests have been generated and your project has been updated.
                </div>
            `;
        }

        // Jira update status
        if (result.jira_update_status) {
            if (result.jira_update_status.success) {
                html += `
                    <div class="alert alert-success mt-3">
                        <i class="fab fa-atlassian me-2"></i>
                        <strong>Jira Updated!</strong> ${result.jira_update_status.message}
                    </div>
                `;
            } else {
                html += `
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Jira Update Issue:</strong> ${result.jira_update_status.message}
                    </div>
                `;
            }
        }

        // Existing tests message
        if (result.message) {
            html += `
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    ${result.message}
                </div>
            `;
        }

        resultsContent.innerHTML = html;
        resultsSection.style.display = 'block';
    }

    function showError(error) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
        alertDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error:</strong> ${error}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    function showSuccess(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
        alertDiv.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            <strong>Success!</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
});

function showTestDetails(testData) {
    let html = '<div class="modal fade" id="testDetailsModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">';
    html += '<div class="modal-header"><h5 class="modal-title">Test Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>';
    html += '<div class="modal-body">';
    
    if (testData.test_cases) {
        html += '<h6>Test Cases:</h6><div class="accordion" id="testCasesAccordion">';
        testData.test_cases.forEach((tc, index) => {
            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                            ${tc.name || `Test Case ${index + 1}`}
                        </button>
                    </h2>
                    <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#testCasesAccordion">
                        <div class="accordion-body">
                            <p><strong>Description:</strong> ${tc.description || 'N/A'}</p>
                            ${tc.steps ? `<p><strong>Steps:</strong></p><ol>${tc.steps.map(step => `<li>${step}</li>`).join('')}</ol>` : ''}
                            <p><strong>Expected Result:</strong> ${tc.expected_result || 'N/A'}</p>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
    }
    
    if (testData.test_code) {
        html += '<h6 class="mt-3">Generated Code:</h6>';
        html += `<pre class="bg-light p-3 rounded"><code>${testData.test_code}</code></pre>`;
    }
    
    html += '</div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>';
    
    // Remove existing modal if any
    const existingModal = document.getElementById('testDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal
    document.body.insertAdjacentHTML('beforeend', html);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('testDetailsModal'));
    modal.show();
}

async function checkStatus() {
    try {
        const response = await fetch('/status');
        const status = await response.json();
        
        // Update status indicators
        updateStatusIndicator('github-status', 'github-text', status.github_connected, 'GitHub');
        updateStatusIndicator('jira-status', 'jira-text', status.jira_connected, 'Jira');
        
        // Show detailed status
        const statusContent = document.getElementById('status-content');
        statusContent.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Connection Status</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-circle ${status.github_connected ? 'text-success' : 'text-danger'} me-2"></i>GitHub: ${status.github_connected ? 'Connected' : 'Not Connected'}</li>
                        <li><i class="fas fa-circle ${status.jira_connected ? 'text-success' : 'text-danger'} me-2"></i>Jira: ${status.jira_connected ? 'Connected' : 'Not Connected'}</li>
                        <li><i class="fas fa-circle ${status.repo_selected ? 'text-success' : 'text-warning'} me-2"></i>Repository: ${status.repo_selected ? 'Selected' : 'Not Selected'}</li>
                        <li><i class="fas fa-circle ${status.project_selected ? 'text-success' : 'text-warning'} me-2"></i>Project: ${status.project_selected ? 'Selected' : 'Not Selected'}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>Collections Status</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-database me-2 text-info"></i>Documentation: ${status.collections_info?.docs_count || 0} embeddings</li>
                        <li><i class="fas fa-database me-2 text-info"></i>Tests: ${status.collections_info?.tests_count || 0} embeddings</li>
                    </ul>
                    <small class="text-muted">Last updated: ${new Date(status.timestamp).toLocaleString()}</small>
                </div>
            </div>
        `;
        
        document.getElementById('status-section').style.display = 'block';
        
    } catch (error) {
        console.error('Failed to check status:', error);
    }
}

function updateStatusIndicator(elementId, textId, connected, service) {
    const element = document.getElementById(elementId);
    const textElement = document.getElementById(textId);
    
    if (element && textElement) {
        element.className = `status-indicator ${connected ? 'status-connected' : 'status-disconnected'}`;
        textElement.textContent = `${service} ${connected ? 'Connected' : 'Disconnected'}`;
    }
}
</script>
{% endblock %}
                        <textarea 
                            class="form-control query-input" 
                            id="queryInput" 
                            name="query" 
                            placeholder="Example: I need tests for user authentication with multi-factor authentication, including edge cases for invalid credentials and session management..."
                            required>
                        </textarea>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-gradient-primary btn-lg" id="generateBtn">
                            <i class="fas fa-magic me-2"></i>
                            Generate Tests
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg" id="clearBtn">
                            <i class="fas fa-eraser me-2"></i>
                            Clear
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="row mb-4" id="loadingSection" style="display: none;">
        <div class="col-12">
            <div class="card-modern p-4 text-center">
                <div class="d-flex align-items-center justify-content-center mb-3">
                    <div class="loading-spinner me-3"></div>
                    <h5 class="mb-0">Analyzing your requirements<span class="loading-dots"></span></h5>
                </div>
                <p class="text-muted mb-0">
                    AI is processing your codebase and generating intelligent test cases...
                </p>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="row" id="resultsSection" style="display: none;">
        <!-- Analysis Results -->
        <div class="col-lg-6 mb-4">
            <div class="result-card">
                <div class="result-header">
                    <div class="result-icon" style="background: var(--gradient-primary);">
                        <i class="fas fa-analytics"></i>
                    </div>
                    <div>
                        <h5 class="mb-1">Analysis Results</h5>
                        <p class="text-muted mb-0">AI analysis of existing tests and requirements</p>
                    </div>
                </div>
                <div id="analysisContent">
                    <!-- Analysis content will be populated here -->
                </div>
            </div>
        </div>

        <!-- Generated Tests -->
        <div class="col-lg-6 mb-4">
            <div class="result-card">
                <div class="result-header">
                    <div class="result-icon" style="background: var(--gradient-success);">
                        <i class="fas fa-code"></i>
                    </div>
                    <div>
                        <h5 class="mb-1">Generated Test Cases</h5>
                        <p class="text-muted mb-0">Automatically generated test code and cases</p>
                    </div>
                </div>
                <div id="testContent">
                    <!-- Test content will be populated here -->
                </div>
            </div>
        </div>

        <!-- Jira Integration -->
        <div class="col-12 mb-4">
            <div class="result-card">
                <div class="result-header">
                    <div class="result-icon" style="background: var(--gradient-secondary);">
                        <i class="fab fa-atlassian"></i>
                    </div>
                    <div>
                        <h5 class="mb-1">Jira Integration</h5>
                        <p class="text-muted mb-0">Test cases created/updated in your Jira project</p>
                    </div>
                </div>
                <div id="jiraContent">
                    <!-- Jira content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card-modern p-4">
                <h5 class="mb-3">
                    <i class="fas fa-bolt me-2 text-warning"></i>
                    Quick Actions
                </h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <a href="{{ url_for('select_repo') }}" class="btn btn-outline-primary w-100">
                            <i class="fab fa-github me-2"></i>
                            Change Repository
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('select_project') }}" class="btn btn-outline-secondary w-100">
                            <i class="fab fa-atlassian me-2"></i>
                            Change Project
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('status') }}" class="btn btn-outline-info w-100">
                            <i class="fas fa-info-circle me-2"></i>
                            System Status
                        </a>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100" onclick="location.reload()">
                            <i class="fas fa-sync-alt me-2"></i>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const queryForm = document.getElementById('queryForm');
    const queryInput = document.getElementById('queryInput');
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const loadingSection = document.getElementById('loadingSection');
    const resultsSection = document.getElementById('resultsSection');

    // Form submission
    queryForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const query = queryInput.value.trim();
        if (!query) {
            alert('Please enter your testing requirements.');
            return;
        }

        // Show loading state
        loadingSection.style.display = 'block';
        resultsSection.style.display = 'none';
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
        generateBtn.disabled = true;

        try {
            const formData = new FormData();
            formData.append('query', query);

            const response = await fetch('/query', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            // Hide loading state
            loadingSection.style.display = 'none';
            generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Generate Tests';
            generateBtn.disabled = false;

            if (result.error) {
                throw new Error(result.error);
            }

            // Display results
            displayResults(result);
            resultsSection.style.display = 'block';

        } catch (error) {
            console.error('Error:', error);
            loadingSection.style.display = 'none';
            generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Generate Tests';
            generateBtn.disabled = false;
            
            alert('Error generating tests: ' + error.message);
        }
    });

    // Clear button
    clearBtn.addEventListener('click', function() {
        queryInput.value = '';
        resultsSection.style.display = 'none';
        queryInput.focus();
    });    function showSuccess(message) {
        const alertHtml = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        document.getElementById('connection-alerts').insertAdjacentHTML('beforeend', alertHtml);
    }

    function showError(message) {
        const alertHtml = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        document.getElementById('connection-alerts').insertAdjacentHTML('beforeend', alertHtml);
    }

    function showResults(result) {
        let html = '<div class="row">';
        
        // Analysis section
        if (result.analysis) {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="result-card">
                        <h6><i class="fas fa-analytics me-2"></i>Analysis</h6>
                        <ul class="list-unstyled mb-0">
                            <li><strong>Existing functionality:</strong> ${result.analysis.existing_functionality ? 'Yes' : 'No'}</li>
                            <li><strong>Existing tests:</strong> ${result.analysis.existing_tests ? 'Yes' : 'No'}</li>
                            <li><strong>Needs new tests:</strong> ${result.analysis.needs_new_tests ? 'Yes' : 'No'}</li>
                            <li><strong>Needs test updates:</strong> ${result.analysis.needs_test_updates ? 'Yes' : 'No'}</li>
                        </ul>
                        ${result.analysis.recommendations ? `
                            <div class="mt-2">
                                <strong>Recommendations:</strong>
                                <ul class="mt-1">
                                    ${result.analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Generated tests section
        if (result.generated_tests) {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="result-card">
                        <h6><i class="fas fa-code me-2"></i>Generated Tests</h6>
                        <p><strong>File:</strong> ${result.generated_tests.file_name || 'Generated Test File'}</p>
                        <p><strong>Test Cases:</strong> ${result.generated_tests.test_cases?.length || 0}</p>
                        <div class="code-preview">
                            <pre><code>${result.generated_tests.test_code || 'No test code generated'}</code></pre>
                        </div>
                    </div>
                </div>
            `;
        }

        // Jira status section
        if (result.jira_update_status) {
            html += `
                <div class="col-12 mb-3">
                    <div class="result-card">
                        <h6><i class="fab fa-atlassian me-2"></i>Jira Integration</h6>
                        ${result.jira_update_status.success ? 
                            `<div class="alert alert-success mb-0">
                                <i class="fas fa-check-circle me-2"></i>
                                ${result.jira_update_status.message}
                                ${result.jira_update_status.issue_key ? `<br><strong>Issue:</strong> ${result.jira_update_status.issue_key}` : ''}
                            </div>` :
                            `<div class="alert alert-warning mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                ${result.jira_update_status.message || 'Failed to update Jira'}
                            </div>`
                        }
                    </div>
                </div>
            `;
        }

        html += '</div>';
        resultsContent.innerHTML = html;
        resultsSection.style.display = 'block';
    }

    // Clear selection functions
    window.clearGithubSelection = function() {
        fetch('/clear-github-selection', { method: 'POST' })
            .then(() => location.reload())
            .catch(error => showError('Error clearing GitHub selection'));
    };

    window.clearJiraSelection = function() {
        fetch('/clear-jira-selection', { method: 'POST' })
            .then(() => location.reload())
            .catch(error => showError('Error clearing Jira selection'));
    };

    window.checkStatus = async function() {
        try {
            const response = await fetch('/status');
            const status = await response.json();
            
            const statusSection = document.getElementById('status-section');
            const statusContent = document.getElementById('status-content');
            
            statusContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Connection Status</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-${status.github_connected ? 'check text-success' : 'times text-danger'} me-2"></i>GitHub Connected</li>
                            <li><i class="fas fa-${status.jira_connected ? 'check text-success' : 'times text-danger'} me-2"></i>Jira Connected</li>
                            <li><i class="fas fa-${status.repo_selected ? 'check text-success' : 'times text-warning'} me-2"></i>Repository Selected</li>
                            <li><i class="fas fa-${status.project_selected ? 'check text-success' : 'times text-warning'} me-2"></i>Project Selected</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Collections</h6>
                        <ul class="list-unstyled">
                            <li>Documentation: ${status.collections_info?.docs_count || 0} items</li>
                            <li>Tests: ${status.collections_info?.tests_count || 0} items</li>
                        </ul>
                        <small class="text-muted">Last updated: ${new Date(status.timestamp).toLocaleString()}</small>
                    </div>
                </div>
            `;
            
            statusSection.style.display = 'block';
        } catch (error) {
            showError('Failed to check status');
        }
    };
});
</script>
{% endblock %}
